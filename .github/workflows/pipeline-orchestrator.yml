name: Complete Pipeline Orchestrator

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  orchestrate:
    name: Sequential Workflow Execution
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“Š Step 1 - Run CI Pipeline
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ðŸš€ Triggering CI Pipeline...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'ci.yml',
              ref: 'main'
            });
            console.log('âœ… CI Pipeline triggered');

      - name: â³ Wait for CI Pipeline
        run: |
          echo "Waiting 7 minutes for CI Pipeline to complete..."
          sleep 420

      - name: ðŸ³ Step 2 - Run Docker Build
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ðŸš€ Triggering Docker Build...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'build.yml',
              ref: 'main'
            });
            console.log('âœ… Docker Build triggered');

      - name: â³ Wait for Docker Build
        run: |
          echo "Waiting 4 minutes for Docker Build to complete..."
          sleep 240

      - name: ðŸ”’ Step 3 - Run Security Scan
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ðŸš€ Triggering Security Scan...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'security.yml',
              ref: 'main'
            });
            console.log('âœ… Security Scan triggered');

      - name: â³ Wait for Security Scan
        run: |
          echo "Waiting 16 minutes for Security Scan to complete..."
          sleep 960

      - name: ðŸ§¬ Step 4 - Run Mutation Testing
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ðŸš€ Triggering Mutation Testing...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'mutation-testing.yml',
              ref: 'main'
            });
            console.log('âœ… Mutation Testing triggered');

      - name: â³ Wait for Mutation Testing
        run: |
          echo "Waiting 12 minutes for Mutation Testing to complete..."
          sleep 720

      - name: ðŸŽï¸ Step 5 - Run Performance Regression
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('ðŸš€ Triggering Performance Regression Testing...');
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'performance-regression.yml',
              ref: 'main'
            });
            console.log('âœ… Performance Regression Testing triggered');

      - name: ðŸ“ Create Pipeline Summary
        run: |
          echo "## ðŸŽ¯ Complete Pipeline Orchestrator" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Workflows Executed Sequentially" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| 1ï¸âƒ£ | CI Pipeline | âœ… Triggered |" >> $GITHUB_STEP_SUMMARY
          echo "| 2ï¸âƒ£ | Docker Build | âœ… Triggered |" >> $GITHUB_STEP_SUMMARY
          echo "| 3ï¸âƒ£ | Security Scan | âœ… Triggered |" >> $GITHUB_STEP_SUMMARY
          echo "| 4ï¸âƒ£ | Mutation Testing | âœ… Triggered |" >> $GITHUB_STEP_SUMMARY
          echo "| 5ï¸âƒ£ | Performance Regression | âœ… Triggered |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Total Execution Time" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Estimated Total**: ~40 minutes" >> $GITHUB_STEP_SUMMARY
          echo "- **CI Pipeline**: ~7 min" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Build**: ~4 min" >> $GITHUB_STEP_SUMMARY
          echo "- **Security Scan**: ~16 min" >> $GITHUB_STEP_SUMMARY
          echo "- **Mutation Testing**: ~12 min" >> $GITHUB_STEP_SUMMARY
          echo "- **Performance Regression**: ~1 min" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### â„¹ï¸ Notes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This orchestrator triggers all workflows sequentially to ensure complete analysis." >> $GITHUB_STEP_SUMMARY
          echo "Check the Actions tab for individual workflow results." >> $GITHUB_STEP_SUMMARY

      - name: ðŸŽ‰ Pipeline Complete
        run: |
          echo "âœ… All workflows triggered successfully!"
          echo "ðŸ”— View results in GitHub Actions tab"
